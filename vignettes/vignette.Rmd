---
title: "rsnodas vignette"
author: Logan Schneider
date: "July 12, 2022"
output: 
    bookdown::pdf_document2:
    includes:
    number_sections: TRUE
fontsize: 12pt
header-includes:
  - \usepackage{amsmath}
  - \usepackage{hyperref}
  - \usepackage{url}
  - \usepackage{float}
  - \usepackage{graphicx}
  - \usepackage{xcolor}
  - \newcommand*{\nspace}{\vspace{0.3cm}}
---


\newpage 

```{r setup, include=FALSE}
# for more options see the recording of class
# - https://bookdown.org/yihui/rmarkdown-cookbook/hide-one.html
knitr::opts_chunk$set(echo = FALSE, warning = FALSE,
                      message = FALSE, results = TRUE)
'%>%' <- magrittr::'%>%'
library(rsnodas)
library(ggplot2)
```



# Introduction
This rsnodas package allows users to access, clean, visualize, and analyze data from SNODAS, University of Arizona, and Global Historical Climatology Network daily (GHCND) or Snow Telemetry (SNOTEL) stations. One big contribution of this package is the ability to take make gridded or raster-like predictions from spatial point data. \url{https://www.usu.edu/utahsnowload/}. 

# Downloading SNODAS
SNODAS provides maps of the following data:

\begin{itemize}
\item Snow water equivalent (SWE) 
\item Snow Depth (SnD)
\item Snow melt runoff (SM)
\item Sublimation from the Snow Pack (SSP)
\item Sublimation of Blowing Snow (SBS)
\item Solid and liquid precipitation (PPT)
\item Snow pack average temperature (SPTave)
\end{itemize}

The function `format_date` has the arguments of `day`, `month`, `year` and will create a character vector with each element being a different day. This function can be used inside other functions to allow for mass downloading specific dates of a year.

```{r fdates}
# returns a character vector of April 1st 2004-2022 in the format YYYY-M-D or YYYY-MM-DD.
format_dates(day = 1, month = 4, year = 2004:2022)
```

The function `download_snodas_data` has the arguments of `dates`, `masked`, `remove_zip`, `data_saved`, `out_dir`, and `GTiff`. The user can specify which or all of the 8 options of data to download, where to store, and if they want to save the map as a tif.   

\newpage

```{r snodas, eval = FALSE}
# Download Snodas SWE data for April 1st in 2015 and 2016
snodas_april1 <- download_snodas_data(dates = format_dates(day = 1,
                                                          month = 4,
                                                          year = 2015:16),
                                      masked = TRUE,
                                      remove_zip = TRUE,
                                      data_saved = c("swe"),
                                      out_dir = "snodas_data",
                                      GTiff = FALSE)

# get the pipe function from magrittr
"%>%" <- magrittr::"%>%"

# Get an shape of utah from the maps package
ut_map <- maps::map("state", plot = FALSE, fill = TRUE) %>%
  sf::st_as_sf() %>%
  dplyr::filter(ID == "utah") %>%
  sf::st_transform(crs = sf::st_crs(snodas_april1$'swe_2015_04-01'))

# Crop the maps to just the state of Utah
snodas_ut_2015 <- sf::st_crop(snodas_april1$'swe_2015_04-01', ut_map)

# Change the name so text file isn't seen when plotting
names(snodas_ut_2015) <- "Value"

# Plot SNODAS April 1st 2015 SWE map of Utah with blue outline
ggplot() + 
  stars::geom_stars(data = snodas_ut_2015) +
  geom_sf(data = ut_map, fill = "NA", size = 1, color = "blue") +
  ggtitle("2015 SNODAS SWE predictions") + 
  scale_fill_viridis_c(option = "A") + 
  theme(plot.title = element_text(hjust = 0.5, size = 24),
        text = element_text(size = 22))
```

\begin{figure}[ht]
\centerline{\includegraphics[width=.50\textwidth]{figures/Thesis_SNODAS_map_for_2015.png}}
\caption{\label{SNODAS SWE predictions for April 1st, 2015.}
\small
This is a gridded estimates of SWE throughout the state of Utah with a blue boarder.
}
\end{figure}


# Downloading PRISM climate data

The PRISM climate group has been provided maps since 1895 for the following climate elements:

\begin{itemize}
\item Precipitation (PPT)
\item Minimum and maximum temperature (Tmin and Tmax)
\item Minimum and maximum vapor pressure deficit (vpdmin and vpdmax)
\item mean dew point (tdmean)
\item Elevation (Elev)
\item Total global shortwave solar radiation
\end{itemize}

Most of this data can be downloaded by utilizing the R package, `prism`. This package has a function, `prism_set_dl_dir` to store all the data from PRISM. The functions `get_prism_dailys`, `get_prism_monthlys`, `get_prism_annual`, and `get_prism_normals` are used to download daily, monthly, annual, and 30-year normal data.

```{r prism, eval = FALSE}
prism::prism_set_dl_dir(paste0(getwd(), "/data-raw/prism"))

# Download the 4km resolution of the 30-year average precipitation for the months of March and April
prism::get_prism_normals(type = "ppt", resolution = "4km",
                         mon = 3:4, keepZip = FALSE)

# Download the 30-year annual average precip and annual average temperature
prism::get_prism_normals("ppt", "4km", annual = TRUE, keepZip = FALSE)

```

# Downloading SNOTEL site data

The `data-raw` folder contains an script titled `DATASET` that shows how to download the snotel data by using `download_all_ghcnd_stations` and create the dataset `april_1_snotel_data`.   


```{r snotel, eval = FALSE}
# april 1st data for Snotel stations in Utah
snotel_ut <- rsnodas::april_1_snotel_data

# subset to just April 1st, 2015.
snotel_ut_2015 <- snotel_ut[snotel_ut$DATE == "2015-04-01", ]

```

### Creating gridded estimates from point data

One functionality is the creation of a grid of predictions using precipitation and elevation. This also allows the user to input a model, that only uses 30-year PRISM normal variables.

```{r gam, eval = FALSE}
gam_2015 <- rsnodas::gam_to_raster(model_data = snotel_ut_2015,
    raster_template = snodas_ut_2015,
    path_to_prism = "/Users/loganschneider/Desktop/PRISM")

ggplot() +
  stars::geom_stars(data = gam_2015) +
  geom_sf(data = ut_map, fill = "NA", size = 1, color = "blue") +
  ggtitle("2015 GAM SWE predictions") +
  scale_fill_viridis_c(option = "D") +
  theme(plot.title = element_text(hjust = 0.5, size = 20),
        text = element_text(size = 16))
```

